<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M√çAPP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">FlaskBank</div>
      <nav class="menu">
        <a href="{{ url_for('publicacion_rutas.foro') }}"><i class="fa fa-commenting"></i> Foro</a>
        <a href="{{ url_for('cuenta_rutas.gestionar_cuentas') }}"><i class="fas fa-credit-card"></i> Tarjetas</a>
        <a href="{{ url_for('transaccion_rutas.registrar_transaccion') }}"><i class="fas fa-exchange-alt"></i> Transacci√≥n</a>
        <a href="{{ url_for('usuario_rutas.logout') }}"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a>
      </nav>
    </aside>

    <main class="main-content">
      <!-- Header -->
      <header class="dashboard-header">
        <h2>Hola, {{ usuario.nombre }}. Bienvenido de nuevo!</h2>
        <div class="header-actions">
          <div class="notification">
            <a href="#" class="notification-toggle">
              <i class="fas fa-bell"></i>
              {% if notificaciones|length > 0 %}
                <span class="notification-count">{{ notificaciones|length }}</span>
              {% endif %}
            </a>
            <div class="notification-dropdown">
              {% for noti in notificaciones[:5] %}
                <div class="notification-item">
                  {{ noti.mensaje|truncate(50) }}
                  <small>{{ noti.fecha_creacion.strftime('%H:%M') }}</small>
                </div>
              {% else %}
                <div class="notification-item empty">No tienes notificaciones</div>
              {% endfor %}
              <div class="notification-footer">
                <a href="#">Ver todas</a>
              </div>
            </div>
          </div>
          <div class="user-profile">
            <img src="{{ url_for('static', filename='img/user_default.png') }}" alt="Usuario">
            <span>{{ usuario.nombre }}</span>
          </div>
        </div>
      </header>

      {% if cuenta %}
      <!-- FILTRO Y CARDS -->
      <section class="cards-overview">
        <!-- Filtro -->
        <form class="filters-form" id="filtroForm">
          <input type="hidden" name="cuenta_id" id="filtroCuentaId" value="{{ cuenta.id }}">
          <div class="filters-row">
            <div class="filter-group">
              <label for="inputYear">A√±o</label>
              <input type="number" id="inputYear" min="2000" max="2100" placeholder="AAAA">
            </div>
            <div class="filter-group">
              <label for="inputMonth">Mes</label>
              <input type="number" id="inputMonth" min="1" max="12" placeholder="MM">
            </div>
            <div class="filter-group">
              <label for="inputDay">D√≠a</label>
              <input type="number" id="inputDay" min="1" max="31" placeholder="DD">
            </div>
            <button type="button" id="btnFiltrar" class="filter-btn"><i class="fa fa-filter"></i> Filtrar</button>
            <button type="button" id="btnLimpiar" class="clear-btn"><i class="fa fa-eraser"></i> Limpiar</button>
          </div>
        </form>

        <!-- Cards y dona -->
        <div class="cards-row">
          <div class="card card-altura-unificada">
            <h3>Total Ingresos</h3>
            <p class="positive">‚Ç°{{ total_ingresos | default(0) | round(2) }}</p>
          </div>
          <div class="card card-altura-unificada">
            <h3>Gastos Totales</h3>
            <p class="negative">‚Ç°{{ total_gastos | default(0) | round(2) }}</p>
          </div>
          <div class="card card-altura-unificada">
            <h3>Tarjeta Activa</h3>
            <p><strong>{{ cuenta.nombre }}</strong> ‚Äî ‚Ç°{{ cuenta.saldo }}</p>
            <form class="bank-filter" method="get" action="{{ url_for('index_rutas.home') }}">
              <select name="cuenta_id" onchange="this.form.submit()">
                {% for c in cuentas %}
                  <option value="{{ c.id }}" {% if c.id == cuenta.id %}selected{% endif %}>
                    {{ c.nombre }}
                  </option>
                {% endfor %}
              </select>
            </form>
          </div>
          <div class="card graficos-dona">
            <div class="donut-container">
              <div class="donut-item">
                <h4>Gastos (%)</h4>
                <canvas id="graficoGastos"></canvas>
              </div>
              <div class="donut-item">
                <h4>Ingresos (%)</h4>
                <canvas id="graficoIngresos"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- GR√ÅFICOS DE CATEGOR√çAS -->
      <section class="chart-section" style="display: flex; gap: 32px;">
        <div class="card" style="height: 400px; flex: 1;">
          <h4>Gastos por Categor√≠a</h4>
          <canvas id="graficoCategoriasGasto"></canvas>
        </div>
        <div class="card" style="height: 400px; flex: 1;">
          <h4>Ingresos por Categor√≠a</h4>
          <canvas id="graficoCategoriasIngreso"></canvas>
        </div>
      </section>

      <!-- TRANSACCIONES RECIENTES e IMPORT/EXPORT -->
      <section class="recent-transactions">
        <div class="card">
            <form id="formImportarExcel" class="excel-form" enctype="multipart/form-data">
              <div class="excel-row">
                <div class="excel-group">
                  <label for="cuentaImportar">Tarjeta</label>
                  <select id="cuentaImportar" name="cuenta_id" required>
                    {% for c in cuentas %}
                      <option value="{{ c.id }}" {% if c.id == cuenta.id %}selected{% endif %}>{{ c.nombre }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="excel-group">
                  <label for="excelFile">Archivo Excel</label>
                  <label class="import-btn">
                    <input id="excelFile" type="file" name="archivo_excel" accept=".xlsx,.xls,.csv" required hidden>
                    <i class="fa fa-file-import"></i> Seleccionar archivo
                  </label>
                  <span id="file-name" class="excel-file-name"></span>
                </div>
                <button type="submit" class="filter-btn"><i class="fa fa-upload"></i> Importar Excel</button>
              </div>
            </form>
          <button class="export-btn" onclick="exportarExcel()">
            <i class="fas fa-file-excel"></i> Exportar a Excel
          </button>
          <h4>Transacciones recientes</h4>
          <table class="transactions-table">
            <thead>
              <tr>
                <th>Categor√≠a</th>
                <th>Tipo</th>
                <th>Descripci√≥n</th>
                <th>Monto</th>
              </tr>
            </thead>
            {% for item in categorias %}
              {% for trans in item.transacciones %}
                <tr>
                  <td>{{ item.categoria.nombre }}</td>
                  <td>{{ item.categoria.tipo.value }}</td>
                  <td>{{ trans.descripcion }}</td>
                  <td class="{% if trans.monto >= 0 %}positive{% else %}negative{% endif %}">
                    {{ "‚Ç°" if trans.monto >= 0 else "-‚Ç°" }}{{ trans.monto | abs }}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4">No hay transacciones disponibles</td>
              </tr>
            {% endfor %}
          </table>
        </div>
      </section>
      {% else %}
      <!-- BIENVENIDA SIN CUENTA -->
      <section class="welcome-section">
        <div class="welcome-card">
          <h1>üëã ¬°Hola {{ usuario.nombre }}!</h1>
          <h2>Bienvenido a tu panel financiero</h2>
          <p>Tu espacio central para monitorear y administrar tus finanzas personales.</p>
          <a href="{{ url_for('cuenta_rutas.gestionar_cuentas') }}" class="welcome-btn">
            <i class="fas fa-plus-circle"></i> Crear mi primera tarjeta
          </a>
        </div>
      </section>
      {% endif %}
    </main>
  </div>

<!-- ========== SCRIPTS ========== -->
<script>
let chartGastos = null;
let chartIngresos = null;
let chartCategoriasGasto = null;
let chartCategoriasIngreso = null;

function obtenerDatosGraficos(year, month, day) {
  const cuentaId = document.getElementById("filtroCuentaId").value;
  let params = [];
  if (cuentaId) params.push("cuenta_id=" + cuentaId);
  if (year) params.push("year=" + year);
  if (month) params.push("month=" + month);
  if (day) params.push("day=" + day);
  const url = "/api/datos_graficos?" + params.join("&");
  return fetch(url).then(resp => resp.json());
}

function porcentaje(valor, total) {
  return total > 0 ? (valor / total * 100).toFixed(1) : 0;
}

function actualizarGraficos(datos) {
  const gastos = datos.datos_grafico.gastos;
  const ingresos = datos.datos_grafico.ingresos;
  const total = ingresos + gastos;

  if (chartGastos) chartGastos.destroy();
  chartGastos = new Chart(document.getElementById('graficoGastos').getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: ['Gastos', 'Resto'],
      datasets: [{
        data: [gastos, ingresos],
        backgroundColor: ['#ff4d4d', '#e0e0e0']
      }]
    },
    options: {
      cutout: '70%',
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return `${ctx.label}: ${porcentaje(ctx.raw, total)}%`;
            }
          }
        },
        legend: { display: false }
      }
    }
  });

  if (chartIngresos) chartIngresos.destroy();
  chartIngresos = new Chart(document.getElementById('graficoIngresos').getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: ['Ingresos', 'Resto'],
      datasets: [{
        data: [ingresos, gastos],
        backgroundColor: ['#4caf50', '#e0e0e0']
      }]
    },
    options: {
      cutout: '70%',
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return `${ctx.label}: ${porcentaje(ctx.raw, total)}%`;
            }
          }
        },
        legend: { display: false }
      }
    }
  });

  // Barras GASTOS por categor√≠a
  const categoriasGasto = datos.datos_grafico_categoria || [];
  const labelsGasto = categoriasGasto.map(item => item.nombre);
  const valoresGasto = categoriasGasto.map(item => item.total);
  const canvasGasto = document.getElementById('graficoCategoriasGasto');
  canvasGasto.height = Math.min(categoriasGasto.length * 40, 400);
  if (chartCategoriasGasto) chartCategoriasGasto.destroy();
  chartCategoriasGasto = new Chart(canvasGasto.getContext('2d'), {
    type: 'bar',
    data: {
      labels: labelsGasto,
      datasets: [{
        label: 'Gastos por Categor√≠a',
        data: valoresGasto,
        backgroundColor: '#e74c3c',
        barThickness: 20
      }]
    },
    options: {
      indexAxis: 'y',
      maintainAspectRatio: false,
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => `‚Ç°${context.raw.toLocaleString()}`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            callback: value => `‚Ç°${value}`
          }
        }
      }
    }
  });

  // Barras INGRESOS por categor√≠a
  const categoriasIngreso = datos.datos_grafico_categoria_ingreso || [];
  const labelsIngreso = categoriasIngreso.map(item => item.nombre);
  const valoresIngreso = categoriasIngreso.map(item => item.total);
  const canvasIngreso = document.getElementById('graficoCategoriasIngreso');
  canvasIngreso.height = Math.min(categoriasIngreso.length * 40, 400);
  if (chartCategoriasIngreso) chartCategoriasIngreso.destroy();
  chartCategoriasIngreso = new Chart(canvasIngreso.getContext('2d'), {
    type: 'bar',
    data: {
      labels: labelsIngreso,
      datasets: [{
        label: 'Ingresos por Categor√≠a',
        data: valoresIngreso,
        backgroundColor: '#4caf50',
        barThickness: 20
      }]
    },
    options: {
      indexAxis: 'y',
      maintainAspectRatio: false,
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => `‚Ç°${context.raw.toLocaleString()}`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            callback: value => `‚Ç°${value}`
          }
        }
      }
    }
  });
}

document.getElementById('btnFiltrar').onclick = () => {
  const year = document.getElementById('inputYear').value;
  const month = document.getElementById('inputMonth').value;
  const day = document.getElementById('inputDay').value;
  obtenerDatosGraficos(year, month, day).then(actualizarGraficos);
};
document.getElementById('btnLimpiar').onclick = () => {
  document.getElementById('inputYear').value = '';
  document.getElementById('inputMonth').value = '';
  document.getElementById('inputDay').value = '';
  obtenerDatosGraficos('', '', '').then(actualizarGraficos);
};

document.querySelector('select[name="cuenta_id"]').addEventListener('change', function() {
  document.getElementById('filtroCuentaId').value = this.value;
  obtenerDatosGraficos('', '', '').then(actualizarGraficos);
});

window.addEventListener('DOMContentLoaded', function() {
  obtenerDatosGraficos('', '', '').then(actualizarGraficos);
});
</script>
<script src="static/js/script_excel.js"></script>
</body>
</html>
